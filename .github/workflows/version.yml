name: Update version file

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  version:
    # Avoid infinity loop: skip if commit by github-actions
    if: github.actor != 'github-actions[bot]'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # để git rev-parse chính xác

      - name: Generate version file
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          TIME=$(date +%s)

          mkdir -p lua/witch-line

          cat > lua/witch-line/_version.lua <<EOF
          -- This file is auto-generated. DO NOT EDIT.
          return {
            commit = "$COMMIT",
            time = $TIME,
          }
          EOF

      - name: Create Pull Request if version changed
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: auto update version [skip ci]"
          title: "chore: auto update version"
          body: |
            Auto-generated version file.

            - commit: `${{ github.sha }}`
            - generated by GitHub Actions
          branch: chore/version-update
          base: main
          delete-branch: true
          add-paths: |
            lua/witch-line/_version.lua
