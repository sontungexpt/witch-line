name: Update version file

on:
  push:
    branches: [main]

permissions:
  contents: write # cho phÃ©p github-actions push

jobs:
  version:
    # ðŸš« NgÄƒn loop: khÃ´ng cháº¡y náº¿u commit do github-actions táº¡o
    if: github.actor != 'github-actions[bot]'

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ä‘á»ƒ git rev-parse chÃ­nh xÃ¡c

      - name: Generate version file
        run: |
          COMMIT=$(git rev-parse --short HEAD)
          TIME=$(date +%s)

          mkdir -p lua/witch-line

          cat > lua/witch-line/_version.lua <<EOF
          -- This file is auto-generated. DO NOT EDIT.
          return {
            commit = "$COMMIT",
            time = $TIME,
          }
          EOF

      - name: Commit version file if changed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # chá»‰ commit náº¿u file thá»±c sá»± thay Ä‘á»•i
          if ! git diff --quiet; then
            git add lua/witch-line/_version.lua
            git commit -m "chore: auto update version [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
